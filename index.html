<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotton - Instagram Reel Script Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .chat-container {
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .chat-message {
            margin: 10px 0;
        }
        .chat-message.bot {
            background-color: #f1f1f1;
            padding: 8px;
            border-radius: 5px;
        }
        .chat-message.user {
            background-color: #007bff;
            color: white;
            padding: 8px;
            border-radius: 5px;
            text-align: right;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Kotton - Instagram Reel Script Generator</h1>
    <h2>Login</h2>
    <p><a href="https://aqlpovtwrpjvltppcgbi.supabase.co/auth/v1/authorize?provider=google">Login with Google</a></p>
    <h2>Onboarding Chat</h2>
    <div class="chat-container" id="chatContainer"></div>
    <div class="form-group">
        <input type="text" id="chatInput" placeholder="Type your response here..." required>
        <button onclick="sendMessage()">Send</button>
    </div>
    <div class="form-group">
        <label><input type="checkbox" id="consent" required> I agree to data collection for script generation</label>
    </div>
    <button id="submitBtn" style="display: none;" onclick="submitOnboarding()">Submit Onboarding</button>

    <script>
        const questions = [
            { id: 'name', question: 'What’s your name?', type: 'text' },
            { id: 'instagram_username', question: 'What’s your Instagram username?', type: 'text', placeholder: 'e.g., johndoe' },
            { id: 'brandMission', question: 'What’s your brand mission?', type: 'text' },
            { id: 'brandTone', question: 'What’s your preferred brand tone? (Witty, Inspirational, Raw, Other)', type: 'select', options: ['Witty', 'Inspirational', 'Raw', 'Other'] },
            { id: 'humorLevel', question: 'Rate your content’s humor level (1–5):', type: 'number', min: 1, max: 5 }
        ];
        let currentQuestionIndex = 0;
        const responses = {};
        let admiredCount = 0;
        let dislikedCount = 0;

        function addMessage(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function askQuestion() {
            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                addMessage(q.question, 'bot');
                const input = document.getElementById('chatInput');
                input.placeholder = q.placeholder || 'Type your response here...';
                if (q.type === 'select') {
                    input.style.display = 'none';
                    const select = document.createElement('select');
                    select.id = 'chatSelect';
                    q.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });
                    document.getElementById('chatInput').parentElement.appendChild(select);
                } else if (q.type === 'number') {
                    input.type = 'number';
                    input.min = q.min;
                    input.max = q.max;
                } else {
                    input.type = 'text';
                }
            } else if (admiredCount < 10 || dislikedCount < 10) {
                addMessage('Would you like to add an admired or disliked Instagram account? Type "admired" or "disliked" to add an account, or "done" to finish.', 'bot');
            } else {
                addMessage('All done! Please check the consent box and click Submit to complete onboarding.', 'bot');
                document.getElementById('submitBtn').style.display = 'block';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const select = document.getElementById('chatSelect');
            let answer = select ? select.value : input.value.trim();
            if (!answer) return;

            addMessage(answer, 'user');
            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                responses[q.id] = answer;
                currentQuestionIndex++;
                if (select) {
                    select.remove();
                    input.style.display = 'block';
                }
                input.value = '';
                input.type = 'text';
                askQuestion();
            } else if (answer.toLowerCase() === 'admired' && admiredCount < 10) {
                admiredCount++;
                addMessage(`Please provide the URL for admired account ${admiredCount}:`, 'bot');
                input.placeholder = 'e.g., https://www.instagram.com/natgeo/';
                responses[`admiredAccount${admiredCount}`] = { url: '', description: '' };
            } else if (answer.toLowerCase() === 'disliked' && dislikedCount < 10) {
                dislikedCount++;
                addMessage(`Please provide the URL for disliked account ${dislikedCount}:`, 'bot');
                input.placeholder = 'e.g., https://www.instagram.com/brandX/';
                responses[`dislikedAccount${dislikedCount}`] = { url: '', description: '' };
            } else if (answer.toLowerCase() === 'done') {
                addMessage('All done! Please check the consent box and click Submit to complete onboarding.', 'bot');
                document.getElementById('submitBtn').style.display = 'block';
                input.value = '';
            } else if (responses[`admiredAccount${admiredCount}`] && !responses[`admiredAccount${admiredCount}`].url) {
                responses[`admiredAccount${admiredCount}`].url = answer;
                addMessage(`Please provide a description for this admired account:`, 'bot');
                input.placeholder = 'e.g., love storytelling';
            } else if (responses[`admiredAccount${admiredCount}`] && !responses[`admiredAccount${admiredCount}`].description) {
                responses[`admiredAccount${admiredCount}`].description = answer;
                addMessage('Would you like to add another admired or disliked account? Type "admired", "disliked", or "done".', 'bot');
                input.placeholder = 'Type your response here...';
            } else if (responses[`dislikedAccount${dislikedCount}`] && !responses[`dislikedAccount${dislikedCount}`].url) {
                responses[`dislikedAccount${dislikedCount}`].url = answer;
                addMessage(`Please provide a description for this disliked account:`, 'bot');
                input.placeholder = 'e.g., hate clickbait';
            } else if (responses[`dislikedAccount${dislikedCount}`] && !responses[`dislikedAccount${dislikedCount}`].description) {
                responses[`dislikedAccount${dislikedCount}`].description = answer;
                addMessage('Would you like to add another admired or disliked account? Type "admired", "disliked", or "done".', 'bot');
                input.placeholder = 'Type your response here...';
            }
            input.value = '';
        }

        async function submitOnboarding() {
            if (!document.getElementById('consent').checked) {
                alert('Please agree to data collection before submitting.');
                return;
            }

            const data = {
                name: responses.name,
                instagram_username: responses.instagram_username,
                personal_details: {
                    brandMission: responses.brandMission,
                    brandTone: responses.brandTone,
                    humorLevel: responses.humorLevel
                },
                accounts: []
            };

            for (let i = 1; i <= admiredCount; i++) {
                if (responses[`admiredAccount${i}`]) {
                    data.accounts.push({ type: 'admired', url: responses[`admiredAccount${i}`].url, description: responses[`admiredAccount${i}`].description });
                }
            }
            for (let i = 1; i <= dislikedCount; i++) {
                if (responses[`dislikedAccount${i}`]) {
                    data.accounts.push({ type: 'disliked', url: responses[`dislikedAccount${i}`].url, description: responses[`dislikedAccount${i}`].description });
                }
            }

            try {
                const response = await fetch('https://aqlpovtwrpjvltppcgbi.supabase.co/rest/v1/Users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxbHBvdnR3cnBqdmx0cHBjZ2JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0Nzg2MzYsImV4cCI6MjA2MzA1NDYzNn0.tEocJLT-Ep5-12WMIuRak8SWkEvZ_FbjKsrEkNGaHFM'
                    },
                    body: JSON.stringify({ name: data.name, instagram_username: data.instagram_username, personal_details: data.personal_details })
                });
                const user = await response.json();
                const userId = user[0].user_id;

                for (const account of data.accounts) {
                    await fetch('https://aqlpovtwrpjvltppcgbi.supabase.co/rest/v1/Instagram_Accounts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxbHBvdnR3cnBqdmx0cHBjZ2JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0Nzg2MzYsImV4cCI6MjA2MzA1NDYzNn0.tEocJLT-Ep5-12WMIuRak8SWkEvZ_FbjKsrEkNGaHFM'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            account_username: account.url.split('/').slice(-2, -1)[0],
                            account_type: account.type,
                            description: account.description
                        })
                    });
                }
                alert('Onboarding completed successfully!');
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('Error submitting form. Please try again.');
            }
        }

        askQuestion();
    </script>
</body>
</html>
