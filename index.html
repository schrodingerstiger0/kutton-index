document.getElementById('onboardingForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const formData = new FormData(this);
    const data = {
        name: formData.get('name'),
        instagram_username: formData.get('instagram_username'),
        personal_details: {
            brandMission: formData.get('brandMission'),
            brandTone: formData.get('brandTone'),
            humorLevel: formData.get('humorLevel')
        },
        accounts: []
    };

    for (let i = 1; i <= admiredCount; i++) {
        const url = formData.get(`admiredAccount${i}`);
        const desc = formData.get(`admiredDesc${i}`);
        if (url) {
            data.accounts.push({ type: 'admired', url, description: desc });
        }
    }
    for (let i = 1; i <= dislikedCount; i++) {
        const url = formData.get(`dislikedAccount${i}`);
        const desc = formData.get(`dislikedDesc${i}`);
        if (url) {
            data.accounts.push({ type: 'disliked', url, description: desc });
        }
    }

    try {
        const userResponse = await fetch('https://aqlpovtwrpjvltppcgbi.supabase.co/rest/v1/Users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxbHBvdnR3cnBqdmx0cHBjZ2JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0Nzg2MzYsImV4cCI6MjA2MzA1NDYzNn0.tEocJLT-Ep5-12WMIuRak8SWkEvZ_FbjKsrEkNGaHFM'
            },
            body: JSON.stringify({ name: data.name, instagram_username: data.instagram_username, personal_details: data.personal_details })
        });

        if (!userResponse.ok) {
            const errorData = await userResponse.json();
            console.error('Supabase API error (Users):', errorData);
            throw new Error('Failed to submit user data: ' + JSON.stringify(errorData));
        }

        const user = await userResponse.json();
        const userId = user[0].user_id;

        for (const account of data.accounts) {
            const accountResponse = await fetch('https://aqlpovtwrpjvltppcgbi.supabase.co/rest/v1/Instagram_Accounts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxbHBvdnR3cnBqdmx0cHBjZ2JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0Nzg2MzYsImV4cCI6MjA2MzA1NDYzNn0.tEocJLT-Ep5-12WMIuRak8SWkEvZ_FbjKsrEkNGaHFM'
                },
                body: JSON.stringify({
                    user_id: userId,
                    account_username: account.url.split('/').slice(-2, -1)[0],
                    account_type: account.type,
                    description: account.description
                })
            });

            if (!accountResponse.ok) {
                const errorData = await accountResponse.json();
                console.error('Supabase API error (Instagram_Accounts):', errorData);
                throw new Error('Failed to submit account data: ' + JSON.stringify(errorData));
            }
        }
        alert('Onboarding completed successfully!');
    } catch (error) {
        console.error('Error submitting form:', error);
        alert('Error submitting form: ' + error.message);
    }
});
